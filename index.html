<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Task Master</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #334155;
            --border: #e2e8f0;
            --danger: #f43f5e;
            --warning: #f59e0b;
            --work-bg: #dbeafe; --work-text: #1e40af;
            --personal-bg: #fef3c7; --personal-text: #92400e;
            --urgent-bg: #fee2e2; --urgent-text: #991b1b;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 650px;
            background: var(--card);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        h1 { text-align: center; margin-bottom: 25px; color: var(--primary); }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .input-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .row { display: flex; gap: 8px; }

        input[type="text"], input[type="date"], select {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            outline: none;
        }

        input[type="text"]:focus { border-color: var(--primary); }
        input[type="text"] { flex: 1; }
        
        button {
            cursor: pointer;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .btn-add { background: var(--primary); color: white; flex: 1; }
        .btn-voice { background: #ec4899; color: white; font-size: 1.2rem; }
        .btn-print { background: #64748b; color: white; width: 100%; margin-top: 20px; }

        /* ã‚½ãƒ¼ãƒˆãƒãƒ¼ */
        .sort-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid var(--border);
            flex-wrap: wrap;
            align-items: center;
        }

        .sort-label {
            font-size: 0.85rem;
            font-weight: bold;
            color: #64748b;
        }

        .sort-btn {
            background: white;
            color: var(--text);
            border: 1px solid var(--border);
            padding: 8px 14px;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .sort-btn:hover {
            background: #f1f5f9;
            border-color: var(--primary);
        }

        .sort-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .sort-btn.desc::after {
            content: ' â–¼';
            font-size: 0.7rem;
        }

        .sort-btn.asc::after {
            content: ' â–²';
            font-size: 0.7rem;
        }

        /* ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ */
        ul { list-style: none; padding: 0; }

        .todo-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            margin-bottom: 12px;
            gap: 12px;
            transition: all 0.2s;
            cursor: grab;
        }

        .todo-item:active {
            cursor: grabbing;
        }

        .todo-item.dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }

        .todo-item.drag-over {
            border-color: var(--primary);
            background: #f0f4ff;
        }

        .drag-handle {
            cursor: grab;
            color: #cbd5e1;
            font-size: 1.2rem;
            padding: 0 5px;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        /* æœŸé™å¼·èª¿ã‚¹ã‚¿ã‚¤ãƒ« */
        .status-overdue { border-color: var(--danger); background: #fff1f2; }
        .status-near { border-color: var(--warning); background: #fffbeb; }

        .todo-content { flex: 1; display: flex; flex-direction: column; gap: 6px; }
        
        /* ç·¨é›†å¯èƒ½ãªãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ */
        .todo-text {
            font-weight: 500;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s;
            display: inline-block;
            min-width: 50px;
        }
        .todo-text:hover { background: #f1f5f9; cursor: text; }
        .todo-text:focus { background: white; outline: 2px solid var(--primary); }

        .completed .todo-text { text-decoration: line-through; color: #94a3b8; opacity: 0.6; }

        /* ãƒãƒƒã‚¸è¡¨ç¤º */
        .meta-info { display: flex; flex-wrap: wrap; gap: 8px; font-size: 0.75rem; }
        .badge { padding: 2px 10px; border-radius: 99px; font-weight: bold; }
        .badge-date { background: #e2e8f0; color: #475569; }
        .alert-text { color: var(--danger); font-weight: bold; margin-left: 4px; }

        .cat-ä»•äº‹ { background: var(--work-bg); color: var(--work-text); }
        .cat-å€‹äºº { background: var(--personal-bg); color: var(--personal-text); }
        .cat-ç·Šæ€¥ { background: var(--urgent-bg); color: var(--urgent-text); }

        .btn-delete { background: none; color: #cbd5e1; font-size: 1.4rem; padding: 0 5px; }
        .btn-delete:hover { color: var(--danger); }

        .recording { animation: pulse 1.5s infinite; background: #f43f5e !important; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        @media print {
            .input-section, .sort-bar, .btn-print, .btn-delete, .drag-handle, input[type="checkbox"] { display: none !important; }
            .container { box-shadow: none; border: none; width: 100%; }
            .todo-item { border: 1px solid #ccc; background: white !important; cursor: default !important; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Smart Task Planner</h1>

    <div class="input-section">
        <div class="row">
            <input type="text" id="todo-input" placeholder="ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›ï¼ˆã¾ãŸã¯ãƒã‚¤ã‚¯ã§å…¥åŠ›ï¼‰">
            <button class="btn-voice" id="voice-btn" title="éŸ³å£°å…¥åŠ›">ğŸ¤</button>
        </div>
        <div class="row">
            <input type="date" id="todo-date" title="æœŸé™">
            <select id="todo-category">
                <option value="ä»•äº‹">ä»•äº‹</option>
                <option value="å€‹äºº">å€‹äºº</option>
                <option value="ç·Šæ€¥">ç·Šæ€¥</option>
            </select>
            <button class="btn-add" id="add-btn">ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </button>
        </div>
    </div>

    <div class="sort-bar">
        <span class="sort-label">ä¸¦ã³æ›¿ãˆ:</span>
        <button class="sort-btn" data-sort="manual">æ‰‹å‹•é †</button>
        <button class="sort-btn" data-sort="date">æœŸé™é †</button>
        <button class="sort-btn" data-sort="created">ä½œæˆé †</button>
        <button class="sort-btn" data-sort="category">ã‚«ãƒ†ã‚´ãƒªãƒ¼é †</button>
        <button class="sort-btn" data-sort="priority">å„ªå…ˆåº¦é †</button>
    </div>

    <ul id="todo-list"></ul>

    <button class="btn-print" onclick="window.print()">ãƒªã‚¹ãƒˆã‚’å°åˆ·ãƒ»PDFä¿å­˜</button>
</div>

<script>
    const input = document.getElementById('todo-input');
    const dateInput = document.getElementById('todo-date');
    const categoryInput = document.getElementById('todo-category');
    const todoList = document.getElementById('todo-list');

    let todos = JSON.parse(localStorage.getItem('pro-todos-v2')) || [];
    let currentSort = { type: 'manual', order: 'asc' };
    let draggedIndex = null;

    function save() {
        localStorage.setItem('pro-todos-v2', JSON.stringify(todos));
    }

    // æœŸé™ã®è¨ˆç®—ï¼ˆä»Šæ—¥ã€æœŸé™åˆ‡ã‚Œã€è¿‘ã„ï¼‰
    function getDeadlineStatus(dateStr) {
        if (!dateStr) return '';
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const target = new Date(dateStr);
        target.setHours(0, 0, 0, 0);
        
        const diffTime = target - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays <= 0) return 'overdue'; // ä»Šæ—¥ã¾ãŸã¯æœŸé™åˆ‡ã‚Œ
        if (diffDays <= 3) return 'near';    // 3æ—¥ä»¥å†…
        return '';
    }

    function render() {
        // ã‚½ãƒ¼ãƒˆé©ç”¨
        const sortedTodos = applySorting([...todos]);
        
        todoList.innerHTML = '';
        sortedTodos.forEach((todo, displayIndex) => {
            const originalIndex = todos.indexOf(todo);
            const status = getDeadlineStatus(todo.date);
            const li = document.createElement('li');
            li.className = `todo-item ${todo.completed ? 'completed' : ''} ${status ? 'status-' + status : ''}`;
            li.draggable = currentSort.type === 'manual';
            li.dataset.index = originalIndex;
            
            // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆ
            if (currentSort.type === 'manual') {
                li.addEventListener('dragstart', handleDragStart);
                li.addEventListener('dragend', handleDragEnd);
                li.addEventListener('dragover', handleDragOver);
                li.addEventListener('drop', handleDrop);
                li.addEventListener('dragenter', handleDragEnter);
                li.addEventListener('dragleave', handleDragLeave);
            }
            
            li.innerHTML = `
                ${currentSort.type === 'manual' ? '<span class="drag-handle">â‹®â‹®</span>' : ''}
                <input type="checkbox" ${todo.completed ? 'checked' : ''} onchange="toggleTodo(${originalIndex})">
                <div class="todo-content">
                    <span class="todo-text" 
                          contenteditable="true" 
                          onblur="editTodo(${originalIndex}, this.innerText)"
                          onkeydown="handleEditKey(event, this)">${escapeHtml(todo.text)}</span>
                    <div class="meta-info">
                        ${todo.date ? `<span class="badge badge-date">ğŸ“… ${todo.date}${status === 'overdue' ? '<span class="alert-text">ï¼æœŸé™</span>' : ''}</span>` : ''}
                        <span class="badge cat-${todo.category}">${todo.category}</span>
                    </div>
                </div>
                <button class="btn-delete" onclick="deleteTodo(${originalIndex})">Ã—</button>
            `;
            todoList.appendChild(li);
        });
        
        // ã‚½ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
        updateSortButtons();
    }

    // --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---
    function addTodo() {
        const text = input.value.trim();
        if (!text) return;

        todos.push({
            text: text,
            date: dateInput.value,
            category: categoryInput.value,
            completed: false,
            createdAt: new Date().toISOString(),
            order: todos.length
        });

        input.value = '';
        save();
        render();
    }

    function toggleTodo(index) {
        todos[index].completed = !todos[index].completed;
        save();
        render();
    }

    function deleteTodo(index) {
        todos.splice(index, 1);
        save();
        render();
    }

    // ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†ä¿å­˜
    function editTodo(index, newText) {
        todos[index].text = newText.trim();
        save();
        // render()ã‚’å‘¼ã¶ã¨ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚Œã‚‹ãŸã‚ã“ã“ã§ã¯ä¿å­˜ã®ã¿
    }

    function handleEditKey(e, el) {
        if (e.key === 'Enter') {
            e.preventDefault();
            el.blur(); // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤–ã—ã¦ä¿å­˜ã‚’ç¢ºå®šã•ã›ã‚‹
        }
    }

    // --- éŸ³å£°å…¥åŠ› ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
        const recognition = new SpeechRecognition();
        recognition.lang = 'ja-JP';
        recognition.onstart = () => document.getElementById('voice-btn').classList.add('recording');
        recognition.onend = () => document.getElementById('voice-btn').classList.remove('recording');
        recognition.onresult = (e) => {
            const voiceText = e.results[0][0].transcript;
            input.value = voiceText;
            // éŸ³å£°å…¥åŠ›å¾Œã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç·¨é›†ã§ãã‚‹ã‚ˆã†ã€è‡ªå‹•è¿½åŠ ã¯ã›ãšå…¥åŠ›æ¬„ã«å…¥ã‚Œã‚‹ã ã‘ã«ã™ã‚‹
            input.focus();
        };
        document.getElementById('voice-btn').onclick = () => recognition.start();
    }

    function escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    // ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
    function applySorting(todoArray) {
        if (currentSort.type === 'manual') {
            return todoArray.sort((a, b) => {
                const orderA = a.order !== undefined ? a.order : 999999;
                const orderB = b.order !== undefined ? b.order : 999999;
                return orderA - orderB;
            });
        }
        
        const sorted = [...todoArray];
        
        switch(currentSort.type) {
            case 'date':
                sorted.sort((a, b) => {
                    if (!a.date && !b.date) return 0;
                    if (!a.date) return 1;
                    if (!b.date) return -1;
                    return currentSort.order === 'asc' 
                        ? new Date(a.date) - new Date(b.date)
                        : new Date(b.date) - new Date(a.date);
                });
                break;
                
            case 'created':
                sorted.sort((a, b) => {
                    const dateA = new Date(a.createdAt || 0);
                    const dateB = new Date(b.createdAt || 0);
                    return currentSort.order === 'asc' 
                        ? dateA - dateB
                        : dateB - dateA;
                });
                break;
                
            case 'category':
                const categoryOrder = { 'ç·Šæ€¥': 1, 'ä»•äº‹': 2, 'å€‹äºº': 3 };
                sorted.sort((a, b) => {
                    const orderA = categoryOrder[a.category] || 999;
                    const orderB = categoryOrder[b.category] || 999;
                    return currentSort.order === 'asc'
                        ? orderA - orderB
                        : orderB - orderA;
                });
                break;
                
            case 'priority':
                // å„ªå…ˆåº¦: æœŸé™åˆ‡ã‚Œ > æœŸé™è¿‘ã„ > ç·Šæ€¥ã‚«ãƒ†ã‚´ãƒª > æœŸé™ã‚ã‚Š > ãã®ä»–
                sorted.sort((a, b) => {
                    const getPriority = (todo) => {
                        const status = getDeadlineStatus(todo.date);
                        if (status === 'overdue') return 1;
                        if (status === 'near') return 2;
                        if (todo.category === 'ç·Šæ€¥') return 3;
                        if (todo.date) return 4;
                        return 5;
                    };
                    
                    const priA = getPriority(a);
                    const priB = getPriority(b);
                    return currentSort.order === 'asc'
                        ? priA - priB
                        : priB - priA;
                });
                break;
        }
        
        return sorted;
    }

    function updateSortButtons() {
        document.querySelectorAll('.sort-btn').forEach(btn => {
            const sortType = btn.dataset.sort;
            btn.classList.remove('active', 'asc', 'desc');
            
            if (sortType === currentSort.type) {
                btn.classList.add('active');
                if (sortType !== 'manual') {
                    btn.classList.add(currentSort.order);
                }
            }
        });
    }

    function changeSortType(type) {
        if (currentSort.type === type && type !== 'manual') {
            // åŒã˜ã‚½ãƒ¼ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰æ˜‡é †ãƒ»é™é †ã‚’åˆ‡ã‚Šæ›¿ãˆ
            currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.type = type;
            currentSort.order = 'asc';
        }
        render();
    }

    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½
    function handleDragStart(e) {
        draggedIndex = parseInt(e.target.dataset.index);
        e.target.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragEnd(e) {
        e.target.classList.remove('dragging');
        document.querySelectorAll('.todo-item').forEach(item => {
            item.classList.remove('drag-over');
        });
    }

    function handleDragOver(e) {
        if (e.preventDefault) {
            e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        return false;
    }

    function handleDragEnter(e) {
        e.target.closest('.todo-item')?.classList.add('drag-over');
    }

    function handleDragLeave(e) {
        e.target.closest('.todo-item')?.classList.remove('drag-over');
    }

    function handleDrop(e) {
        if (e.stopPropagation) {
            e.stopPropagation();
        }
        
        const dropTarget = e.target.closest('.todo-item');
        if (!dropTarget) return false;
        
        const dropIndex = parseInt(dropTarget.dataset.index);
        
        if (draggedIndex !== dropIndex) {
            // é…åˆ—ã®ä¸¦ã³æ›¿ãˆ
            const draggedItem = todos[draggedIndex];
            todos.splice(draggedIndex, 1);
            
            const newDropIndex = todos.indexOf(todos.find(t => todos.indexOf(t) === (dropIndex > draggedIndex ? dropIndex - 1 : dropIndex)));
            todos.splice(newDropIndex + (dropIndex > draggedIndex ? 1 : 0), 0, draggedItem);
            
            // orderå€¤ã‚’å†è¨ˆç®—
            todos.forEach((todo, idx) => {
                todo.order = idx;
            });
            
            save();
            render();
        }
        
        return false;
    }

    // ã‚½ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            changeSortType(btn.dataset.sort);
        });
    });

    document.getElementById('add-btn').onclick = addTodo;
    input.onkeypress = (e) => { if (e.key === 'Enter') addTodo(); };

    // æ—¢å­˜ã®todosã«createdAtã¨orderãŒãªã„å ´åˆã¯è¿½åŠ 
    todos.forEach((todo, index) => {
        if (!todo.createdAt) {
            todo.createdAt = new Date().toISOString();
        }
        if (todo.order === undefined) {
            todo.order = index;
        }
    });
    save();

    render();
</script>

</body>
</html>
